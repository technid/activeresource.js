/*
	active-resource 1.0.0
	(c) 2017 Nick Landgrebe && Peak Labs, LLC DBA Occasion App
	active-resource may be freely distributed under the MIT license
	Portions of active-resource were inspired by or borrowed from Rail's ActiveRecord library
*/

!function(root,factory){"function"==typeof define&&define.amd?define(["axios","es6-promise","underscore","underscore.string","qs","underscore.inflection"],factory):"object"==typeof exports?(require("underscore.inflection"),module.exports=factory(require("axios"),require("es6-promise"),require("underscore"),require("underscore.string"),require("qs"))):root.ActiveResource=factory(root.axios,root.es6Promise,root._,root.s,root.Qs)}(this,function(axios,es6Promise,_,s,Qs){var ActiveResource=function(){};return window.Promise=es6Promise.Promise,function(){ActiveResource.extend=function(klass,mixin){var method,name,_results;_results=[];for(name in mixin)method=mixin[name],method.__excludeFromExtend?_results.push(void 0):_results.push(klass[name]=method);return _results},ActiveResource.include=function(klass,mixin){return this.extend(klass.prototype,mixin)}}.call(this),function(){ActiveResource.prototype.Typing=function(){function Typing(){}return Typing.klass=function(){return this.constructor},Typing.isA=function(klass){var match,object;for(object=this,match=object.constructor===klass;!match&&null!=(object=object.constructor.__super__);)match=object.constructor===klass;return match},Typing}()}.call(this),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};ActiveResource.createResourceLibrary=function(baseUrl,options){var ResourceLibrary;return null==options&&(options={}),ResourceLibrary=function(){function ResourceLibrary(){}var Base,resourceLibrary,_ref;return ResourceLibrary.baseUrl="/"===baseUrl.charAt(baseUrl.length-1)?baseUrl:""+baseUrl+"/",ResourceLibrary.headers=options.headers,ResourceLibrary["interface"]=new(options["interface"]||ActiveResource.Interfaces.JsonApi)(ResourceLibrary),ResourceLibrary.constantizeScope=options.constantizeScope,resourceLibrary=ResourceLibrary,ResourceLibrary.Base=Base=function(_super){function Base(){return _ref=Base.__super__.constructor.apply(this,arguments)}return __extends(Base,_super),Base.resourceLibrary=resourceLibrary,Base}(ActiveResource.prototype.Base),ResourceLibrary.constantize=function(className){var klass,scope,v,_i,_len;if(klass=null,!_.isUndefined(className)&&!_.isNull(className))for(scope=this.constantizeScope&&_.values(this.constantizeScope)||_.flatten([_.values(this),_.values(this.prototype)]),_i=0,_len=scope.length;_len>_i;_i++)v=scope[_i],_.isObject(v)&&v.className===className&&(klass=v);if(null==klass)throw"NameError: klass "+className+" does not exist";return klass},ResourceLibrary}.call(this)}}.call(this),function(){ActiveResource.Interfaces=ActiveResource.prototype.Interfaces=function(){function Interfaces(){}return Interfaces.prototype.Base=function(){function Base(resourceLibrary){this.resourceLibrary=resourceLibrary}return Base.prototype.request=function(url,method,data){var options;return options={responseType:"json",headers:_.extend(this.resourceLibrary.headers,{"Content-Type":"application/json"}),method:method,url:url},"GET"===method?(options.params=data,options.paramsSerializer=function(params){return Qs.stringify(params,{arrayFormat:"brackets"})}):options.data=data,axios(options)},Base.prototype.get=function(url,queryParams){throw"#get not implemented on base interface"},Base.prototype.post=function(url,resourceData,options){throw"#post not implemented on base interface"},Base.prototype.patch=function(url,resourceData,options){throw"#patch not implemented on base interface"},Base.prototype.put=function(url,resourceData,options){throw"#put not implemented on base interface"},Base.prototype["delete"]=function(url,resourceData,options){throw"#delete not implemented on base interface"},Base}(),Interfaces}()}.call(this),function(){var _ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},__slice=[].slice;ActiveResource.Interfaces.JsonApi=ActiveResource.prototype.Interfaces.prototype.JsonApi=function(_super){function JsonApi(){return _ref=JsonApi.__super__.constructor.apply(this,arguments)}return __extends(JsonApi,_super),JsonApi.prototype.request=function(url,method,data){return JsonApi.__super__.request.apply(this,arguments).then(function(response){var _ref1;if(null==(null!=(_ref1=response.data)?_ref1.data:void 0)&&204!==response.status)throw"Response from "+url+" was not in JSON API format";return response.data})},JsonApi.prototype.toUnderscored=function(object){var k,underscored,v;underscored={};for(k in object)v=object[k],underscored[s.underscored(k)]=_.isArray(v)?_.map(v,function(i){return this.toUnderscored(i)}):!_.isObject(v)||("function"==typeof v.isA?v.isA(ActiveResource.prototype.Base):void 0)||("function"==typeof v.isA?v.isA(ActiveResource.prototype.Collection):void 0)||_.isDate(v)?v:this.toUnderscored(v);return underscored},JsonApi.prototype.toCamelCase=function(object){var camelized,k,v;camelized={};for(k in object)v=object[k],camelized[s.camelize(k)]=_.isArray(v)?_.map(v,function(i){return this.toCamelCase(i)}):!_.isObject(v)||("function"==typeof v.isA?v.isA(ActiveResource.prototype.Base):void 0)||("function"==typeof v.isA?v.isA(ActiveResource.prototype.Collection):void 0)?v:this.toCamelCase(v);return camelized},JsonApi.prototype.buildSparseFieldset=function(fields){return _.mapObject(fields,function(fieldArray){return _.map(fieldArray,function(f){return s.underscored(f)}).join()})},JsonApi.prototype.buildIncludeTree=function(includes){var buildNestedIncludes;return buildNestedIncludes=function(object){var includeCollection,modelName,value;return modelName=s.underscored(_.keys(object)[0]),value=_.values(object)[0],includeCollection=ActiveResource.prototype.Collection.build([value]).flatten().map(function(item){return _.isString(item)?_.map(item.split(","),function(i){return s.underscored(i)}):_.isObject(item)?buildNestedIncludes(item):void 0}).flatten(),includeCollection.map(function(i){return""+modelName+"."+i}).toArray()},ActiveResource.prototype.Collection.build(includes).inject([],function(includeStrArray,include){return _.isObject(include)?(includeStrArray.push.apply(includeStrArray,buildNestedIncludes(include)),includeStrArray):(includeStrArray.push(s.underscored(include)),includeStrArray)}).join()},JsonApi.prototype.buildSortList=function(sortObject){var column,dir,output;output=[];for(column in sortObject)dir=sortObject[column],"asc"===dir?output.push(s.underscored(column)):"desc"===dir&&output.push("-"+s.underscored(column));return output.join(",")},JsonApi.prototype.buildResourceIdentifier=function(resource){var identifier,primaryKeyValue;return identifier={type:resource.klass().queryName},(primaryKeyValue=resource[resource.klass().primaryKey])&&(identifier[resource.klass().primaryKey]=primaryKeyValue.toString()),identifier},JsonApi.prototype.buildResourceRelationships=function(resource,relationships,onlyChanged){var output,_this=this;return null==onlyChanged&&(onlyChanged=!1),output={},_.each(relationships,function(relationship){var reflection,target;return reflection=resource.klass().reflectOnAssociation(relationship),target=resource.association(reflection.name).target,reflection.collection()&&target.empty()||null===target?void 0:output[s.underscored(reflection.name)]={data:_this.buildResourceDocument({resourceData:target,onlyResourceIdentifiers:!reflection.autosave(),onlyChanged:onlyChanged,parentReflection:reflection.inverseOf()||{name:reflection.options.as}})}}),output},JsonApi.prototype.buildResourceDocument=function(_arg){var data,onlyChanged,onlyResourceIdentifiers,parentReflection,resourceData,_this=this;return resourceData=_arg.resourceData,onlyResourceIdentifiers=_arg.onlyResourceIdentifiers,onlyChanged=_arg.onlyChanged,parentReflection=_arg.parentReflection,onlyResourceIdentifiers=onlyResourceIdentifiers||!1,onlyChanged=onlyChanged||!1,data=ActiveResource.prototype.Collection.build(resourceData).compact().map(function(resource){var attributes,changedFields,documentResource,relationships;return documentResource=_this.buildResourceIdentifier(resource),onlyResourceIdentifiers||(attributes=_.omit(resource.attributes(),resource.klass().primaryKey),relationships=_.keys(resource.klass().reflections()),parentReflection&&(relationships=_.without(relationships,parentReflection.name)),onlyChanged&&(changedFields=resource.changedFields().toArray(),attributes=_.pick.apply(_,[attributes].concat(__slice.call(changedFields))),relationships=_.intersection(relationships,changedFields)),documentResource.attributes=_this.toUnderscored(attributes),documentResource.relationships=_this.buildResourceRelationships(resource,relationships,onlyChanged)),documentResource}),_.isArray(resourceData)||_.isObject(resourceData)&&("function"==typeof resourceData.isA?resourceData.isA(ActiveResource.prototype.Collection):void 0)?data.toArray():data.first()},JsonApi.prototype.buildResource=function(data,includes,_arg){var attributes,existingResource,parentRelationship,resource;return existingResource=_arg.existingResource,parentRelationship=_arg.parentRelationship,resource=existingResource||this.resourceLibrary.constantize(_.singularize(s.classify(data.type))).build(),attributes=data.attributes,data[resource.klass().primaryKey]&&(attributes[resource.klass().primaryKey]=data[resource.klass().primaryKey].toString()),null!=parentRelationship&&(attributes=_.extend(attributes,parentRelationship)),attributes=this.addRelationshipsToAttributes(attributes,data.relationships,includes,resource),resource.__assignFields(this.toCamelCase(attributes)),resource.__links=_.extend(resource.links(),data.links),resource.klass().reflectOnAllAssociations().each(function(reflection){var association,relationship,relationshipEmpty,relationshipLinks,selfLink,_ref1,_ref2,_ref3,_ref4;return association=resource.association(reflection.name),null!=(relationshipLinks=null!=(_ref1=data.relationships)&&null!=(_ref2=_ref1[s.underscored(reflection.name)])?_ref2.links:void 0)?association.__links=_.extend(association.links(),_.mapObject(relationshipLinks,function(l){return s.endsWith(l,"/")?l:l+"/"})):null!=(selfLink=resource.links().self)&&(selfLink=s.endsWith(selfLink,"/")?selfLink:selfLink+"/",association.__links={self:selfLink+("relationships/"+reflection.name),related:selfLink+reflection.name}),relationshipEmpty=_.isObject(relationship=null!=(_ref3=data.relationships)&&null!=(_ref4=_ref3[s.underscored(reflection.name)])?_ref4.data:void 0)?0===_.keys(relationship).length:null!=relationship?0===relationship.length:!0,_.has(attributes,reflection.name)||relationshipEmpty?association.loaded(!0):void 0}),resource},JsonApi.prototype.addRelationshipsToAttributes=function(attributes,relationships,includes,resource){var _this=this;return _.each(relationships,function(relationship,relationshipName){var include,parentReflection,reflection,relationshipItems;if(reflection=resource.klass().reflectOnAssociation(s.camelize(relationshipName)))if(parentReflection=reflection.inverseOf(),reflection.collection()){if(relationshipItems=ActiveResource.prototype.Collection.build(relationship.data).map(function(relationshipMember){return _this.findIncludeFromRelationship(relationshipMember,includes,resource,parentReflection)}).compact(),!("function"==typeof relationshipItems.empty?relationshipItems.empty():void 0))return attributes[relationshipName]=relationshipItems}else if(null!=relationship.data&&(include=_this.findIncludeFromRelationship(relationship.data,includes,resource,parentReflection),null!=include))return attributes[relationshipName]=include}),attributes},JsonApi.prototype.findIncludeFromRelationship=function(relationshipData,includes,resource,parentReflection){var findConditions,include,parentRelationship;return findConditions={type:relationshipData.type},findConditions[resource.klass().primaryKey]=relationshipData[resource.klass().primaryKey],parentRelationship={},null!=parentReflection&&(parentRelationship[parentReflection.name]=resource),null!=(include=_.findWhere(includes,findConditions))&&(include=this.buildResource(include,includes,{parentRelationship:parentRelationship})),include},JsonApi.prototype.mergePersistedChanges=function(response,resource){return this.buildResource(response.data,response.included,{existingResource:resource})},JsonApi.prototype.resourceErrors=function(resource,errors){return _.each(errors,function(error){var attribute;return attribute=[],"/data"===error.source.pointer?attribute.push("base"):_.each(error.source.pointer.split("/data"),function(i){var m;return null!=(m=i.match(/\/(attributes|relationships|)\/(\w+)/))?attribute.push(s.camelize(m[2])):void 0}),resource.errors().add(attribute.join("."),s.camelize(error.code),error.detail)}),resource},JsonApi.prototype.parameterErrors=function(errors){return ActiveResource.prototype.Collection.build(errors).map(function(error){var out,_ref1;return out={details:error.detail},null!=(null!=(_ref1=error.source)?_ref1.parameter:void 0)&&(out.parameter=s.camelize(error.source.parameter)),out.code=s.camelize(error.code),out})},JsonApi.prototype.get=function(url,queryParams){var data,_this;return null==queryParams&&(queryParams={}),data={},null!=queryParams.filter&&(data.filter=this.toUnderscored(queryParams.filter)),null!=queryParams.fields&&(data.fields=this.buildSparseFieldset(queryParams.fields)),null!=queryParams.include&&(data.include=this.buildIncludeTree(queryParams.include)),null!=queryParams.sort&&(data.sort=this.buildSortList(queryParams.sort)),null!=queryParams.page&&(data.page=queryParams.page),null!=queryParams.limit&&(data.limit=queryParams.limit),null!=queryParams.offset&&(data.offset=queryParams.offset),_this=this,this.request(url,"GET",data).then(function(response){var built;return built=ActiveResource.prototype.CollectionResponse.build(_.flatten([response.data])).map(function(object){return object=_this.buildResource(object,response.included,{}),object.assignResourceRelatedQueryParams(queryParams),object}),built.links(response.links),_.isArray(response.data)?built:built.first()},function(errors){return Promise.reject(_this.parameterErrors(errors.response.data.errors))})},JsonApi.prototype.post=function(url,resourceData,options){var data,queryParams,_this;return null==options&&(options={}),data={data:this.buildResourceDocument({resourceData:resourceData,onlyResourceIdentifiers:options.onlyResourceIdentifiers})},options.onlyResourceIdentifiers||(queryParams=resourceData.queryParams(),null!=queryParams.fields&&(data.fields=this.buildSparseFieldset(queryParams.fields)),null!=queryParams.include&&(data.include=this.buildIncludeTree(queryParams.include))),_this=this,this.request(url,"POST",data).then(function(response){return options.onlyResourceIdentifiers?response:_this.mergePersistedChanges(response,resourceData)},function(errors){return options.onlyResourceIdentifiers?Promise.reject(errors):Promise.reject(_this.resourceErrors(resourceData,errors.response.data.errors))})},JsonApi.prototype.patch=function(url,resourceData,options){var data,queryParams,_this;return null==options&&(options={}),data={data:this.buildResourceDocument({resourceData:resourceData,onlyResourceIdentifiers:options.onlyResourceIdentifiers,onlyChanged:!0})},options.onlyResourceIdentifiers||(queryParams=resourceData.queryParams(),null!=queryParams.fields&&(data.fields=this.buildSparseFieldset(queryParams.fields)),null!=queryParams.include&&(data.include=this.buildIncludeTree(queryParams.include))),_this=this,this.request(url,"PATCH",data).then(function(response){return options.onlyResourceIdentifiers?response:_this.mergePersistedChanges(response,resourceData)},function(errors){return options.onlyResourceIdentifiers?Promise.reject(errors):Promise.reject(_this.resourceErrors(resourceData,errors.response.data.errors))})},JsonApi.prototype.put=function(url,resourceData,options){var data,queryParams,_this;return null==options&&(options={}),data={data:this.buildResourceDocument({resourceData:resourceData,onlyResourceIdentifiers:options.onlyResourceIdentifiers})},options.onlyResourceIdentifiers||(queryParams=resourceData.queryParams(),null!=queryParams.fields&&(data.fields=this.buildSparseFieldset(queryParams.fields)),null!=queryParams.include&&(data.include=this.buildIncludeTree(queryParams.include))),_this=this,this.request(url,"PUT",data).then(function(response){return options.onlyResourceIdentifiers?response:_this.mergePersistedChanges(response,resourceData)},function(errors){return options.onlyResourceIdentifiers?Promise.reject(errors):Promise.reject(_this.resourceErrors(resourceData,errors.response.data.errors))})},JsonApi.prototype["delete"]=function(url,resourceData,options){var data,_this;return null==options&&(options={}),data=null!=resourceData?{data:this.buildResourceDocument({resourceData:resourceData,onlyResourceIdentifiers:!0})}:{},_this=this,this.request(url,"DELETE",data).then(null,function(errors){return errors.response.data?Promise.reject(_this.parameterErrors(errors.response.data.errors)):Promise.reject(null)})},JsonApi}(ActiveResource.prototype.Interfaces.prototype.Base)}.call(this),function(){ActiveResource.prototype.Associations=function(){function Associations(){}return Associations.prototype.association=function(name){var association,reflection;if(this.__associations||(this.__associations={}),null==(association=this.__associations[name])){if(null==(reflection=this.klass().reflectOnAssociation(name)))throw"Association "+name+" does not exist";association=new(reflection.associationClass())(this,reflection),this.__associations[name]=association}return association},Associations.hasMany=function(name,options){var reflection;return null==options&&(options={}),reflection=ActiveResource.prototype.Associations.prototype.Builder.prototype.HasMany.build(this,name,options),ActiveResource.prototype.Reflection.addReflection(this,name,reflection)},Associations.hasOne=function(name,options){var reflection;return null==options&&(options={}),reflection=ActiveResource.prototype.Associations.prototype.Builder.prototype.HasOne.build(this,name,options),ActiveResource.prototype.Reflection.addReflection(this,name,reflection)},Associations.belongsTo=function(name,options){var reflection;return null==options&&(options={}),reflection=ActiveResource.prototype.Associations.prototype.Builder.prototype.BelongsTo.build(this,name,options),ActiveResource.prototype.Reflection.addReflection(this,name,reflection)},Associations}()}.call(this),function(){var __slice=[].slice;ActiveResource.prototype.Attributes=function(){function Attributes(){}return Attributes.prototype.attributes=function(){var attributes,_ref;return attributes=1<=arguments.length?__slice.call(arguments,0):[],null!=this.__attributes?(_ref=this.__attributes).push.apply(_ref,attributes):this.__attributes=ActiveResource.prototype.Collection.build(attributes),this.__attributes},Attributes.hasAttribute=function(attribute){return null!=this.__readAttribute(attribute)},Attributes.assignAttributes=function(attributes){var k,v,_base;for(k in attributes){v=attributes[k];try{("function"==typeof(_base=this.association(k).reflection).collection?_base.collection():void 0)?this[k]().assign(v,!1):this["assign"+s.capitalize(k)](v)}catch(_error){this[k]=v}}return null},Attributes.attributes=function(){var k,output,reserved,v,validOutput;reserved=["__associations","__errors","__fields","__links","__queryParams"],validOutput=function(k,v){var e;return!_.isFunction(v)&&!_.contains(reserved,k)&&function(){try{return null==this.association(k)}catch(_error){return e=_error,!0}}.call(this)},output={};for(k in this)v=this[k],validOutput(k,v)&&(output[k]=v);return output},Attributes.reload=function(){var link,resource,_ref;if(!(this.persisted()||(null!=(_ref=this.id)?_ref.toString().length:void 0)>0))throw"Cannot reload a resource that is not persisted or has an ID";return resource=this,link=this.links().self||this.links().related+this.id.toString(),this["interface"]().get(link,this.queryParams()).then(function(reloaded){return resource.__assignFields(reloaded.attributes()),resource.klass().reflectOnAllAssociations().each(function(reflection){var target;return target=reloaded.association(reflection.name).reader(),("function"==typeof reflection.collection?reflection.collection():void 0)&&(target=target.toArray()),resource.association(reflection.name).writer(target,!1)}),resource})},Attributes.__readAttribute=function(attribute){return this.attributes()[attribute]},Attributes}()}.call(this),function(){ActiveResource.prototype.Callbacks=function(){function Callbacks(){}return Callbacks.prototype.callbacks=function(){return this.__callbacks||(this.__callbacks={afterBuild:ActiveResource.prototype.Collection.build()})},Callbacks.prototype.afterBuild=function(func){return this.callbacks().afterBuild.push(func)},Callbacks.__executeCallbacks=function(type){var _this=this;return this.klass().callbacks()[type].each(function(callback){return _.bind(callback,_this)()})},Callbacks}()}.call(this),function(){var __slice=[].slice;ActiveResource.prototype.Collection=function(){function Collection(__collection){this.__collection=null!=__collection?__collection:[]}return ActiveResource.include(Collection,ActiveResource.prototype.Typing),Collection.build=function(array){return null==array&&(array=[]),("function"==typeof array.isA?array.isA(this):void 0)?array.clone():new this(null!=array.length?array:[array])},Collection.prototype.size=function(){return _.size(this.__collection)},Collection.prototype.empty=function(){return 0===this.size()},Collection.prototype.include=function(item){return _.indexOf(this.__collection,item)>=0},Collection.prototype.get=function(index){return index>=this.size()?void 0:this.__collection[index]},Collection.prototype.set=function(index,item){return index>=this.size()?void 0:this.__collection[index]=item},Collection.prototype.toArray=function(){return this.__collection},Collection.prototype.all=function(){return this.toArray()},Collection.prototype.first=function(n){var output;return output=_.first(this.__collection,n||1),n?output:output[0]},Collection.prototype.last=function(n){var output;return output=_.last(this.__collection,n||1),n?output:output[0]},Collection.prototype.each=function(iteratee){return _.each(this.__collection,iteratee)},Collection.prototype.inject=function(memo,iteratee){return _.reduce(this.__collection,iteratee,memo)},Collection.prototype.map=function(iteratee){return this.constructor.build(_.map(this.__collection,iteratee))},Collection.prototype.compact=function(iteratee){return this.constructor.build(_.without(this.__collection,null,void 0))},Collection.prototype.join=function(separator){return null==separator&&(separator=","),s.join.apply(s,[separator].concat(__slice.call(_.map(this.__collection,function(i){return i.toString()}))))},Collection.prototype.flatten=function(){return this.constructor.build(_.flatten(this.__collection))},Collection.prototype.push=function(){var objs,_ref;return objs=1<=arguments.length?__slice.call(arguments,0):[],(_ref=this.__collection).push.apply(_ref,objs)},Collection.prototype["delete"]=function(){var deleted,items;return items=1<=arguments.length?__slice.call(arguments,0):[],deleted=_.intersection(this.__collection,items),this.__collection=_.without.apply(_,[this.__collection].concat(__slice.call(items))),deleted},Collection.prototype.clear=function(){return this.__collection=[]},Collection.prototype.select=function(predicate){return this.constructor.build(_.filter(this.__collection,predicate))},Collection.prototype.detect=function(predicate){return _.detect(this.__collection,predicate)},Collection.prototype.clone=function(){return this.constructor.build(_.map(this.__collection,function(i){return i}))},Collection}()}.call(this),function(){var _ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};ActiveResource.prototype.CollectionResponse=function(_super){function CollectionResponse(){return _ref=CollectionResponse.__super__.constructor.apply(this,arguments)}return __extends(CollectionResponse,_super),CollectionResponse.build=function(array){return null==array&&(array=[]),("function"==typeof array.isA?array.isA(ActiveResource.prototype.Collection):void 0)?new this(array.toArray()):CollectionResponse.__super__.constructor.build.apply(this,arguments)},CollectionResponse.prototype.links=function(data){return null==data&&(data={}),_.isEmpty(data)&&null!=this.__links||(this.__links=data),this.__links},CollectionResponse.prototype.hasPrevPage=function(){return null!=this.links().prev},CollectionResponse.prototype.hasNextPage=function(){return null!=this.links().next},CollectionResponse.prototype.prevPage=function(){return this.hasPrevPage()?this.first().klass().resourceLibrary["interface"].get(this.links().prev):void 0},CollectionResponse.prototype.nextPage=function(){return this.hasNextPage()?this.first().klass().resourceLibrary["interface"].get(this.links().next):void 0},CollectionResponse.prototype.toCollection=function(){return ActiveResource.prototype.Collection.build(this.toArray())},CollectionResponse}(ActiveResource.prototype.Collection)}.call(this),function(){ActiveResource.prototype.Errors=function(){function Errors(base){this.base=base,this.reset()}return Errors.errors=function(){return this.__errors||(this.__errors=new ActiveResource.prototype.Errors(this))},Errors.valid=function(){return this.errors().empty()},Errors.prototype.reset=function(){return this.__errors={}},Errors.prototype.clear=function(){return this.reset()},Errors.prototype.add=function(field,code,detail){var error,_base;return null==detail&&(detail=""),(_base=this.__errors)[field]||(_base[field]=[]),this.__errors[field].push(error={field:field,code:code,detail:detail,message:detail}),error},Errors.prototype.push=function(error){var _base,_name;return(_base=this.__errors)[_name=error.field]||(_base[_name]=[]),this.__errors[error.field].push(error),error},Errors.prototype.added=function(field,code){return null!=ActiveResource.prototype.Collection.build(this.__errors[field]).detect(function(e){return e.code===code})},Errors.prototype.include=function(field){return null!=this.__errors[field]&&_.size(this.__errors[field])>0},Errors.prototype.empty=function(){return 0===this.size()},Errors.prototype.size=function(){return _.size(this.toArray())},Errors.prototype["delete"]=function(field){return this.__errors[field]=[]},Errors.prototype.each=function(iterator){return _.each(this.__errors,function(errors,field){var error,_i,_len,_results;for(_results=[],_i=0,_len=errors.length;_len>_i;_i++)error=errors[_i],_results.push(iterator(field,error));return _results})},Errors.prototype.forField=function(field){var _this=this;return ActiveResource.prototype.Collection.build(_.keys(this.__errors)).select(function(k){return s.startsWith(k,field)}).map(function(k){return _this.__errors[k]}).flatten()},Errors.prototype.detailsForField=function(field){return this.forField(field).inject({},function(out,error){return out[error.code]=error.detail,out})},Errors.prototype.forBase=function(){return this.forField("base")},Errors.prototype.toArray=function(){var errors,field,output,_ref;output=[],_ref=this.__errors;for(field in _ref)errors=_ref[field],output.push.apply(output,errors);return output},Errors.prototype.toCollection=function(){return ActiveResource.prototype.Collection.build(this.toArray())},Errors}()}.call(this),function(){ActiveResource.prototype.Fields=function(){function Fields(){}return Fields.prototype.fields=function(){var output;return output=ActiveResource.prototype.Collection.build(this.attributes()),output.push.apply(output,_.keys(this.reflections())),output},Fields.__initializeFields=function(){var _this=this;return this.__fields={},this.klass().fields().each(function(field){var _ref;return(null!=(_ref=_this.klass().reflectOnAssociation(field))?_ref.collection():void 0)?_this.__fields[field]=ActiveResource.prototype.Collection.build():_this.__fields[field]=null})},Fields.__assignFields=function(fields){var _this=this;return _.each(fields,function(v,k){if(_.has(_this.__fields,k))try{return _this.association(k).reflection.collection()?_this.__fields[k]=ActiveResource.prototype.Collection.build(v):_this.__fields[k]=v}catch(_error){return _this.__fields[k]=v}}),this.assignAttributes(fields)},Fields.changed=function(){return!this.changedFields().empty()},Fields.changedFields=function(){var _this=this;return this.klass().fields().select(function(field){var association,newField,newTargets,oldField;oldField=_this.__fields[field],newField=_this[field];try{return association=_this.association(field),newField=_this[field](),association.reflection.collection()?oldField.size()!==newField.size()?!0:(newTargets=newField.target().select(function(t){return!oldField.include(t)||association.reflection.autosave()&&t.changed()}),!newTargets.empty()):oldField!==newField||association.reflection.autosave()&&newField.changed()}catch(_error){return oldField!==newField}})},Fields}()}.call(this),function(){ActiveResource.prototype.Persistence=function(){function Persistence(){}return Persistence.persisted=function(){return null!=this.links().self},Persistence.newResource=function(){return!this.persisted()},Persistence.save=function(callback){return this.__createOrUpdate().then(callback,callback)},Persistence.update=function(attributes,callback){var oldAttributes;return oldAttributes=_.pick(this.attributes(),_.keys(attributes)),this.assignAttributes(attributes),this.__createOrUpdate().then(null,function(resource){return resource.assignAttributes(oldAttributes),resource}).then(callback,callback)},Persistence.destroy=function(){var resource;return this.klass().resourceLibrary["interface"]["delete"](this.links().self,resource=this).then(function(){return resource.__links={},resource})},Persistence.__createOrUpdate=function(){return this.errors().reset(),this.persisted()?this.klass().resourceLibrary["interface"].patch(this.links().self,this):this.klass().resourceLibrary["interface"].post(this.links().related,this)},Persistence}()}.call(this),function(){var __slice=[].slice;ActiveResource.prototype.QueryParams=function(){function QueryParams(){}var COLLECTION_RELATED,RESOURCE_RELATED;return RESOURCE_RELATED=["fields","include"],COLLECTION_RELATED=["filter","sort","page"],QueryParams.queryParams=function(){return this.__queryParams||(this.__queryParams=("function"==typeof this.isA?this.isA(ActiveResource.prototype.Base):void 0)?_.clone(this.klass().queryParams()):{})},QueryParams.queryParamsForReflection=function(reflection){var includes,queryParams,_ref;return queryParams={},null!=this.queryParams().include&&(includes=ActiveResource.prototype.Collection.build(this.queryParams().include).inject([],function(out,i){return _.isObject(i)&&_.each(_.keys(i),function(i2){return i2===reflection.name?out.push.apply(out,_.flatten([i[i2]])):void 0}),out}),0!==includes.length&&(queryParams.include=includes)),("function"==typeof reflection.polymorphic?reflection.polymorphic():void 0)||null==(null!=(_ref=this.queryParams().fields)?_ref[reflection.klass().queryName]:void 0)||(queryParams.fields=_.pick(this.queryParams().fields,reflection.klass().queryName)),queryParams},QueryParams.assignQueryParams=function(queryParams){return this.__queryParams=queryParams},QueryParams.assignResourceRelatedQueryParams=function(queryParams){return this.assignQueryParams(_.pick.apply(_,[queryParams].concat(__slice.call(RESOURCE_RELATED))))},QueryParams.resetQueryParams=function(){return this.__queryParams={}},QueryParams.__resourceRelatedParams=function(){
return _.pick.apply(_,[this.queryParams()].concat(__slice.call(RESOURCE_RELATED)))},QueryParams.__collectionRelatedParams=function(){return _.pick.apply(_,[this.queryParams()].concat(__slice.call(COLLECTION_RELATED)))},QueryParams.__extendValueParam=function(param,value,queryParams){return queryParams||(queryParams=_.clone(this.queryParams())),queryParams[param]=value,queryParams},QueryParams.__extendObjectParam=function(param,options,queryParams){return queryParams||(queryParams=_.clone(this.queryParams())),queryParams[param]=_.extend(queryParams[param]||{},options),queryParams},QueryParams.__extendArrayParam=function(param,items,queryParams){var _ref;return queryParams||(queryParams=_.clone(this.queryParams())),queryParams[param]=queryParams[param]?queryParams[param].slice(0):[],null!=items&&(_ref=queryParams[param]).push.apply(_ref,items),queryParams},QueryParams}()}.call(this),function(){var __slice=[].slice,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};ActiveResource.prototype.Reflection=function(){function Reflection(){}var _ref,_ref1,_ref2;return Reflection.prototype.reflections=function(){return this.__reflections||(this.__reflections={})},Reflection.prototype.reflectOnAllAssociations=function(macro){var reflections;return null==macro&&(macro=null),reflections=ActiveResource.prototype.Collection.build(_.values(this.__reflections)),macro&&(reflections=reflections.select(function(r){return r.macro===macro})),reflections},Reflection.prototype.reflectOnAssociation=function(association){return this.reflections()[association]},Reflection.prototype.reflectOnAllAutosaveAssociations=function(){var reflections;return reflections=ActiveResource.prototype.Collection.build(_.values(this.__reflections)),reflections.select(function(r){return"function"==typeof r.autosave?r.autosave():void 0})},Reflection.create=function(macro,name,options,activeResource){var klass;return new(klass=function(){switch(macro){case"hasMany":return Reflection.prototype.HasManyReflection;case"hasOne":return Reflection.prototype.HasOneReflection;case"belongsTo":return Reflection.prototype.BelongsToReflection}}())(name,options,activeResource)},Reflection.addReflection=function(ar,name,reflection){var r;return r={},r[name]=reflection,ar.__reflections=_.extend(ar.__reflections||{},r)},Reflection.prototype.AbstractReflection=function(){function AbstractReflection(name,options,activeResource){this.name=name,this.options=options,this.activeResource=activeResource,this.autosave()&&this.activeResource.assignQueryParams(this.activeResource.__extendArrayParam("include",[this.name]))}var INVALID_AUTOMATIC_INVERSE_OPTIONS,VALID_AUTOMATIC_INVERSE_MACROS,automaticInverseOf,canFindInverseOfAutomatically,validInverseReflection;return ActiveResource.include(AbstractReflection,ActiveResource.prototype.Typing),AbstractReflection.__excludeFromExtend=!0,AbstractReflection.prototype.klass=function(){return this.activeResource.resourceLibrary.constantize(this.className())},AbstractReflection.prototype.type=function(){return this.__type||(this.__type=this.options.as&&(this.options.foreignType||""+this.options.as+"Type"))},AbstractReflection.prototype.className=function(){return this.__className||(this.__className=this.options.className||this.__deriveClassName())},AbstractReflection.prototype.foreignKey=function(){return this.__foreignKey||(this.__foreignKey=this.options.foreignKey||this.__deriveForeignKey())},AbstractReflection.prototype.foreignType=function(){return this.__foreignType||(this.__foreignType=this.options.foreignType||""+this.name+"Type")},AbstractReflection.prototype.associationPrimaryKey=function(klass){return this.options.primaryKey||this.__primaryKey(klass||this.klass())},AbstractReflection.prototype.activeResourcePrimaryKey=function(){return this.__activeResourcePrimaryKey||(this.__activeResourcePrimaryKey=this.options.primaryKey||this.__primaryKey(this.activeResource))},AbstractReflection.prototype.collection=function(){return!1},AbstractReflection.prototype.hasOne=function(){return!1},AbstractReflection.prototype.belongsTo=function(){return!1},AbstractReflection.prototype.constructable=function(){return!0},AbstractReflection.prototype.polymorphic=function(){return this.options.polymorphic||!1},AbstractReflection.prototype.autosave=function(){return this.options.autosave||!1},AbstractReflection.prototype.buildAssociation=function(){return this.klass().build()},AbstractReflection.prototype.hasInverse=function(){return null!=this.__inverseName()},AbstractReflection.prototype.inverseOf=function(){return this.hasInverse()?this.__inverseOf||(this.__inverseOf=this.klass().reflectOnAssociation(this.__inverseName())):void 0},AbstractReflection.prototype.polymorphicInverseOf=function(associatedClass){var inverseRelationship;return this.hasInverse()&&(inverseRelationship=associatedClass.reflectOnAssociation(this.options.inverseOf))?inverseRelationship:void 0},AbstractReflection.prototype.__deriveClassName=function(){return s.classify(_.singularize(this.name))},AbstractReflection.prototype.__deriveForeignKey=function(){return this.belongsTo()?""+this.name+"Id":this.options.as?""+this.options.as+"Id":""+s.camelize(this.activeResource.className,!0)+"Id"},AbstractReflection.prototype.__primaryKey=function(klass){return klass.primaryKey||function(){throw"Unknown primary key for "+klass.className}()},AbstractReflection.prototype.__inverseName=function(){return this.options.inverseOf||(this.__automaticInverseOf===!1?null:this.__automaticInverseOf||(this.__automaticInverseOf=automaticInverseOf(this)))},automaticInverseOf=function(reflection){var e,inverseName,inverseReflection;if(canFindInverseOfAutomatically(reflection)){inverseName=s.camelize(reflection.options.as||reflection.activeResource.className,!0);try{inverseReflection=reflection.klass().reflectOnAssociation(inverseName)}catch(_error){e=_error,inverseReflection=!1}if(validInverseReflection(reflection,inverseReflection))return inverseName}return!1},VALID_AUTOMATIC_INVERSE_MACROS=["hasMany","hasOne","belongsTo"],INVALID_AUTOMATIC_INVERSE_OPTIONS=["polymorphic"],canFindInverseOfAutomatically=function(reflection){return reflection.options.inverseOf!==!1&&_.include(VALID_AUTOMATIC_INVERSE_MACROS,reflection.macro)&&_.isEmpty(_.pick.apply(_,[reflection.options].concat(__slice.call(INVALID_AUTOMATIC_INVERSE_OPTIONS))))},validInverseReflection=function(reflection,inverseReflection){return null!=inverseReflection&&reflection.klass().className===inverseReflection.activeResource.className&&canFindInverseOfAutomatically(inverseReflection)},AbstractReflection}(),Reflection.prototype.HasManyReflection=function(_super){function HasManyReflection(){return _ref=HasManyReflection.__super__.constructor.apply(this,arguments)}return __extends(HasManyReflection,_super),HasManyReflection.__excludeFromExtend=!0,HasManyReflection.prototype.macro="hasMany",HasManyReflection.prototype.collection=function(){return!0},HasManyReflection.prototype.associationClass=function(){return ActiveResource.prototype.Associations.prototype.HasManyAssociation},HasManyReflection}(Reflection.prototype.AbstractReflection),Reflection.prototype.HasOneReflection=function(_super){function HasOneReflection(){return _ref1=HasOneReflection.__super__.constructor.apply(this,arguments)}return __extends(HasOneReflection,_super),HasOneReflection.__excludeFromExtend=!0,HasOneReflection.prototype.macro="hasOne",HasOneReflection.prototype.hasOne=function(){return!0},HasOneReflection.prototype.associationClass=function(){return ActiveResource.prototype.Associations.prototype.HasOneAssociation},HasOneReflection}(Reflection.prototype.AbstractReflection),Reflection.prototype.BelongsToReflection=function(_super){function BelongsToReflection(){return _ref2=BelongsToReflection.__super__.constructor.apply(this,arguments)}return __extends(BelongsToReflection,_super),BelongsToReflection.__excludeFromExtend=!0,BelongsToReflection.prototype.macro="belongsTo",BelongsToReflection.prototype.belongsTo=function(){return!0},BelongsToReflection.prototype.constructable=function(){return!this.polymorphic()},BelongsToReflection.prototype.associationClass=function(){return this.polymorphic()?ActiveResource.prototype.Associations.prototype.BelongsToPolymorphicAssociation:ActiveResource.prototype.Associations.prototype.BelongsToAssociation},BelongsToReflection}(Reflection.prototype.AbstractReflection),Reflection}.call(this)}.call(this),function(){var __slice=[].slice;ActiveResource.prototype.Relation=function(){function Relation(base,__queryParams){this.base=base,this.__queryParams=__queryParams,this.queryName=this.base.queryName}return ActiveResource.include(Relation,ActiveResource.prototype.QueryParams),ActiveResource.include(Relation,ActiveResource.prototype.Typing),Relation.prototype.links=function(){return this.base.links()},Relation.prototype["interface"]=function(){return this.base["interface"]()},Relation.prototype.where=function(options){return this.__newRelation(this.__extendObjectParam("filter",options))},Relation.prototype.order=function(args){return this.__newRelation(this.__extendObjectParam("sort",args))},Relation.prototype.select=function(){var args,queryParams,_this=this;return args=1<=arguments.length?__slice.call(arguments,0):[],queryParams=_.clone(this.queryParams()),queryParams.fields||(queryParams.fields={}),ActiveResource.prototype.Collection.build(args).map(function(a){var key,_i,_len,_ref,_results;if(_.isObject(a)){for(_ref=_.keys(a),_results=[],_i=0,_len=_ref.length;_len>_i;_i++)key=_ref[_i],_results.push(_.pick(a,key));return _results}return a}).flatten().each(function(arg){var modelName;return modelName=_.isObject(arg)?_.keys(arg)[0]:_this.queryName,queryParams.fields=_this.__extendArrayParam(modelName,_.isObject(arg)?[_.values(arg)[0]]:[arg],queryParams.fields)}),this.__newRelation(queryParams)},Relation.prototype.page=function(value){return this.__newRelation(this.__extendObjectParam("page",{number:value}))},Relation.prototype.perPage=function(value){return this.__newRelation(this.__extendObjectParam("page",{size:value}))},Relation.prototype.limit=function(value){return this.__newRelation(this.__extendValueParam("limit",value))},Relation.prototype.offset=function(value){return this.__newRelation(this.__extendValueParam("offset",value))},Relation.prototype.includes=function(){var args;return args=1<=arguments.length?__slice.call(arguments,0):[],args=ActiveResource.prototype.Collection.build(args).map(function(a){var key,_i,_len,_ref,_results;if(_.isObject(a)){for(_ref=_.keys(a),_results=[],_i=0,_len=_ref.length;_len>_i;_i++)key=_ref[_i],_results.push(_.pick(a,key));return _results}return a}).flatten().toArray(),this.__newRelation(this.__extendArrayParam("include",args))},Relation.prototype.build=function(attributes){var resource;return null==attributes&&(attributes={}),resource=null!=this.base?new this.base:new this,resource.assignAttributes(_.extend(attributes,this.queryParams().filter)),resource.assignResourceRelatedQueryParams(this.queryParams()),resource.__executeCallbacks("afterBuild"),resource},Relation.prototype.create=function(attributes,callback){return null==attributes&&(attributes={}),this.build(attributes).save(callback)},Relation.prototype.find=function(primaryKey){return null!=primaryKey?this["interface"]().get(this.links().related+primaryKey.toString(),this.queryParams()):void 0},Relation.prototype.findBy=function(conditions){return this.where(conditions).first()},Relation.prototype.all=function(){return this["interface"]().get(this.links().related,this.queryParams())},Relation.prototype.each=function(iteratee){return this.all().then(function(collection){return collection.each(iteratee),collection})},Relation.prototype.first=function(n){var relation;return relation=null!=this.queryParams().page?this:this.limit(n||1),relation.all().then(function(collection){return collection.first(n)})},Relation.prototype.last=function(n){var relation;return relation=null!=this.queryParams().page?this:this.offset(-(n||1)).limit(n||1),relation.all().then(function(collection){return collection.last(n)})},Relation.prototype.__newRelation=function(queryParams){return new this.constructor(this.base,queryParams)},Relation}()}.call(this),function(){ActiveResource.prototype.Base=function(){function Base(){this.__initializeFields()}return ActiveResource.extend(Base,ActiveResource.prototype.Associations),ActiveResource.extend(Base,ActiveResource.prototype.Attributes.prototype),ActiveResource.extend(Base,ActiveResource.prototype.Callbacks.prototype),ActiveResource.extend(Base,ActiveResource.prototype.Fields.prototype),ActiveResource.extend(Base,ActiveResource.prototype.Reflection.prototype),ActiveResource.extend(Base,ActiveResource.prototype.Relation.prototype),ActiveResource.include(Base,ActiveResource.prototype.Associations.prototype),ActiveResource.include(Base,ActiveResource.prototype.Attributes),ActiveResource.include(Base,ActiveResource.prototype.Callbacks),ActiveResource.include(Base,ActiveResource.prototype.Errors),ActiveResource.include(Base,ActiveResource.prototype.Fields),ActiveResource.include(Base,ActiveResource.prototype.Persistence),ActiveResource.include(Base,ActiveResource.prototype.QueryParams),ActiveResource.include(Base,ActiveResource.prototype.Typing),Base.queryName="",Base.className="",Base.primaryKey="id",Base.links=function(){if(null==this.resourceLibrary.baseUrl)throw"baseUrl is not set";if(null==this.queryName)throw"queryName is not set";return this.__links||(this.__links={related:this.resourceLibrary.baseUrl+this.queryName+"/"})},Base.prototype.links=function(){return this.__links||(this.__links=_.clone(this.klass().links()))},Base["interface"]=function(){return this.resourceLibrary["interface"]},Base.prototype["interface"]=function(){return this.klass()["interface"]()},Base.prototype.clone=function(){return this.__createClone()},Base.prototype.__createClone=function(cloner){var clone,_this=this;return clone=this.klass().build(this.attributes()),clone.__links=this.links(),this.errors().each(function(attribute,e){return clone.errors().push(_.clone(e))}),this.klass().reflectOnAllAssociations().each(function(reflection){var new_association,new_target,old_association;return old_association=_this.association(reflection.name),new_association=clone.association(reflection.name),new_association.__links=old_association.links(),reflection.collection()?old_association.target.each(function(resource){var new_target;return new_target=resource.__createClone(_this),new_association.setInverseInstance(new_target),new_association.target.push(new_target)}):null!=old_association.target&&old_association.target!==cloner?(new_target=old_association.target.__createClone(_this),new_association.setInverseInstance(new_target),new_association.target=new_target):void 0}),clone},Base.__newRelation=function(queryParams){return new ActiveResource.prototype.Relation(this,queryParams)},Base}()}.call(this),function(){ActiveResource.prototype.Associations.prototype.Association=function(){function Association(owner,reflection){this.owner=owner,this.reflection=reflection,this.reset()}return ActiveResource.include(Association,ActiveResource.prototype.Typing),Association.__excludeFromExtend=!0,Association.prototype.klass=function(){return this.reflection.klass()},Association.prototype.options=function(){return this.reflection.options},Association.prototype.links=function(){return this.__links||(this.__links=_.clone(this.klass().links()))},Association.prototype["interface"]=function(){return this.owner.klass()["interface"]()},Association.prototype.reset=function(){return this.__loaded=!1,this.target=null},Association.prototype.reload=function(){var _this;return this.reset(),_this=this,this.loadTarget().then(function(){return _this})},Association.prototype.loaded=function(set){return null==set&&(set=!1),set&&(this.__loaded=!0),this.__loaded},Association.prototype.loadTarget=function(){var _this;return this.__canFindTarget()?(_this=this,this.__findTarget().then(function(loadedTarget){return _this.target=loadedTarget,_this.loaded(!0),loadedTarget})["catch"](function(){return _this.reset()})):(this.reset(),$.when(null))},Association.prototype.setInverseInstance=function(resource){var inverse;return this.__invertibleFor(resource)&&(inverse=resource.association(this.__inverseReflectionFor(resource).name),inverse.target=this.owner),resource},Association.prototype.__raiseOnTypeMismatch=function(resource){if(!("function"==typeof resource.isA?resource.isA(this.reflection.klass()):void 0))throw""+this.reflection.className()+" expected, got "+resource+" which is an instance of "+resource.constructor},Association.prototype.__canFindTarget=function(){return(!this.owner.newResource()||this.__foreignKeyPresent())&&this.klass()},Association.prototype.__creationAttributes=function(){var attributes,_base,_base1;return attributes={},(("function"==typeof(_base=this.reflection).hasOne?_base.hasOne():void 0)||("function"==typeof(_base1=this.reflection).collection?_base1.collection():void 0))&&(attributes[this.reflection.foreignKey()]=this.owner[this.reflection.activeResourcePrimaryKey()],this.reflection.options.as&&(attributes[this.reflection.type()]=this.owner.klass().className)),attributes},Association.prototype.__setOwnerAttributes=function(resource){var key,value,_ref,_results;_ref=this.__creationAttributes(),_results=[];for(key in _ref)value=_ref[key],_results.push(resource[key]=value);return _results},Association.prototype.__foreignKeyPresent=function(){return!1},Association.prototype.__inverseReflectionFor=function(resource){return this.reflection.inverseOf()},Association.prototype.__invertibleFor=function(resource){return this.__foreignKeyFor(resource)&&this.__inverseReflectionFor(resource)},Association.prototype.__foreignKeyFor=function(resource){return"function"==typeof resource.hasAttribute?resource.hasAttribute(this.reflection.foreignKey()):void 0},Association.prototype.__buildResource=function(attributes){var resource;return resource=this.reflection.buildAssociation(),resource.assignAttributes(attributes),resource},Association}()}.call(this),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};ActiveResource.prototype.Associations.prototype.CollectionAssociation=function(_super){function CollectionAssociation(owner,reflection){this.owner=owner,this.reflection=reflection,this.queryName=this.klass().queryName,CollectionAssociation.__super__.constructor.apply(this,arguments)}return __extends(CollectionAssociation,_super),CollectionAssociation.prototype.reader=function(){return this.proxy||(this.proxy=new ActiveResource.prototype.Associations.prototype.CollectionProxy(this))},CollectionAssociation.prototype.writer=function(resources,save){var localAssignment,persistedResources,_base,_this=this;return null==save&&(save=!0),resources=ActiveResource.prototype.Collection.build(resources),resources.each(function(r){return _this.__raiseOnTypeMismatch(r)}),persistedResources=resources.select(function(r){return"function"==typeof r.persisted?r.persisted():void 0}),_this=this,localAssignment=function(){return save&&_this.loaded(!0),_this.replace(resources),resources},!save||("function"==typeof(_base=this.owner).newResource?_base.newResource():void 0)||!resources.empty()&&persistedResources.empty()?localAssignment():this.__persistAssignment(persistedResources.toArray()).then(localAssignment)},CollectionAssociation.prototype.concat=function(resources){var persistConcat,persistedResources,_base,_this=this;return resources=ActiveResource.prototype.Collection.build(resources),resources.each(function(r){return _this.__raiseOnTypeMismatch(r)}),persistConcat=!("function"==typeof(_base=this.owner).newResource?_base.newResource():void 0)&&(persistedResources=resources.select(function(r){return"function"==typeof r.persisted?r.persisted():void 0})).size()?this.__persistConcat(persistedResources.toArray()):$.when(resources),_this=this,persistConcat.then(function(){return _this.__concatResources(resources)})},CollectionAssociation.prototype["delete"]=function(resources){var persistDelete,persistedResources,_base,_this=this;return resources=ActiveResource.prototype.Collection.build(resources),resources.each(function(r){return _this.__raiseOnTypeMismatch(r)}),persistDelete=!("function"==typeof(_base=this.owner).newResource?_base.newResource():void 0)&&(persistedResources=resources.select(function(r){return"function"==typeof r.persisted?r.persisted():void 0})).size()?this.__persistDelete(persistedResources.toArray()):$.when(resources),_this=this,persistDelete.then(function(){return _this.__removeResources(resources)})},CollectionAssociation.prototype.reset=function(){return CollectionAssociation.__super__.reset.apply(this,arguments),this.target=ActiveResource.prototype.Collection.build()},CollectionAssociation.prototype.addToTarget=function(resource){var index;return index=_.indexOf(this.target.toArray(),resource),0>index&&(index=null),this.replaceOnTarget(resource,index)},CollectionAssociation.prototype.replaceOnTarget=function(resource,index){return null!=index?this.target.set(index,resource):this.target.push(resource),this.setInverseInstance(resource),resource},CollectionAssociation.prototype.empty=function(){return this.target.empty()},CollectionAssociation.prototype.build=function(attributes){var _this=this;return null==attributes&&(attributes={}),_.isArray(attributes)?ActiveResource.prototype.Collection.build(attributes).map(function(attr){return _this.build(attr)}):this.__concatResources(ActiveResource.prototype.Collection.build(this.__buildResource(attributes))).first()},CollectionAssociation.prototype.create=function(attributes,queryParams,callback){return null==attributes&&(attributes={}),null==queryParams&&(queryParams={}),null==callback&&(callback=_.noop()),this.__createResource(attributes,queryParams,callback)},CollectionAssociation.prototype.__findTarget=function(){var _this;return _this=this,this["interface"]().get(this.links().related,this.owner.queryParamsForReflection(this.reflection)).then(function(resources){return resources.each(function(r){return _this.setInverseInstance(r)}),resources})},CollectionAssociation.prototype.replace=function(other){return this.__removeResources(this.target),this.__concatResources(other)},CollectionAssociation.prototype.__concatResources=function(resources){var _this=this;return resources.each(function(resource){return _this.addToTarget(resource),_this.insertResource(resource)}),resources},CollectionAssociation.prototype.__removeResources=function(resources){return this.__deleteResources(resources)},CollectionAssociation.prototype.__deleteResources=function(resources){throw"__deleteResources not implemented on CollectionAssociation"},CollectionAssociation.prototype.__persistAssignment=function(resources){return this["interface"]().patch(this.links().self,resources,{onlyResourceIdentifiers:!0})},CollectionAssociation.prototype.__persistConcat=function(resources){return this["interface"]().post(this.links().self,resources,{onlyResourceIdentifiers:!0})},CollectionAssociation.prototype.__persistDelete=function(resources){return this["interface"]()["delete"](this.links().self,resources,{onlyResourceIdentifiers:!0})},CollectionAssociation.prototype.__createResource=function(attributes,queryParams,callback){var resource,_base,_this;if(!("function"==typeof(_base=this.owner).persisted?_base.persisted():void 0))throw"You cannot call create on an association unless the parent is saved";return resource=this.__buildResource(attributes),resource.assignQueryParams(queryParams),this.insertResource(resource),_this=this,resource.save(callback).then(function(){return _this.addToTarget(resource),resource})},CollectionAssociation}(ActiveResource.prototype.Associations.prototype.Association)}.call(this),function(){var _ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};ActiveResource.prototype.Associations.prototype.CollectionProxy=function(_super){function CollectionProxy(){return _ref=CollectionProxy.__super__.constructor.apply(this,arguments)}return __extends(CollectionProxy,_super),CollectionProxy.__excludeFromExtend=!0,CollectionProxy.prototype.target=function(){return this.base.target},CollectionProxy.prototype.queryParams=function(){var _this=this;return this.__queryParams||(this.__queryParams=function(){var klassQueryParams,queryParams,_base;return queryParams=_.clone(_this.base.owner.queryParamsForReflection(_this.base.reflection)),("function"==typeof(_base=_this.base.reflection).polymorphic?_base.polymorphic():void 0)||(klassQueryParams=_.clone(_this.base.klass().queryParams()),null!=klassQueryParams.include&&(queryParams=_this.__extendArrayParam("include",klassQueryParams.include,queryParams)),null!=klassQueryParams.fields&&_.each(klassQueryParams.fields,function(v,k){var v2;return(v2=queryParams.fields[k])?v2.push.apply(v2,v):queryParams.fields[k]=v})),queryParams}())},CollectionProxy.prototype.all=function(options){return null==options&&(options={}),options.cached?this.target():CollectionProxy.__super__.all.apply(this,arguments)},CollectionProxy.prototype.load=function(){var _this=this;return this.all().then(function(collection){return _this.base.writer(collection,!1)})},CollectionProxy.prototype.toArray=function(){return this.all({cached:!0}).toArray()},CollectionProxy.prototype.size=function(){return this.target().size()},CollectionProxy.prototype.empty=function(){return this.target().empty()},CollectionProxy.prototype.assign=function(other,save){return null==save&&(save=!0),this.base.writer(other,save)},CollectionProxy.prototype.push=function(resources){return this.base.concat(resources)},CollectionProxy.prototype.build=function(attributes){var resources,_this=this;return null==attributes&&(attributes={}),attributes=_.isArray(attributes)?_.map(attributes,function(attr){return _.extend(attr,_this.queryParams().filter)}):_.extend(attributes,this.queryParams().filter),resources=ActiveResource.prototype.Collection.build(this.base.build(attributes)),resources.each(function(r){return r.assignResourceRelatedQueryParams(_this.queryParams())}),resources.size()>1?resources:resources.first()},CollectionProxy.prototype.create=function(attributes,callback){return null==attributes&&(attributes={}),attributes=_.extend(attributes,this.queryParams().filter),this.base.create(attributes,this.__resourceRelatedParams(),callback)},CollectionProxy.prototype.reload=function(){return this.base.reload()},CollectionProxy.prototype["delete"]=function(resources){return this.base["delete"](resources)},CollectionProxy.prototype.deleteAll=function(){return this.base["delete"](this.target())},CollectionProxy}(ActiveResource.prototype.Relation)}.call(this),function(){var _ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};ActiveResource.prototype.Associations.prototype.HasManyAssociation=function(_super){function HasManyAssociation(){return _ref=HasManyAssociation.__super__.constructor.apply(this,arguments)}return __extends(HasManyAssociation,_super),HasManyAssociation.prototype.insertResource=function(resource){return this.__setOwnerAttributes(resource),this.setInverseInstance(resource)},HasManyAssociation.prototype.__deleteResources=function(resources){var _this=this;return resources.each(function(resource){var inverse;return null!=(inverse=_this.reflection.inverseOf())?resource.association(inverse.name).replace(null):resource[_this.reflection.foreignKey()]=null}),this.target=ActiveResource.prototype.Collection.build(_.difference(this.target.toArray(),resources.toArray()))},HasManyAssociation}(ActiveResource.prototype.Associations.prototype.CollectionAssociation)}.call(this),function(){var _ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};ActiveResource.prototype.Associations.prototype.SingularAssociation=function(_super){function SingularAssociation(){return _ref=SingularAssociation.__super__.constructor.apply(this,arguments)}return __extends(SingularAssociation,_super),SingularAssociation.prototype.reader=function(){return this.target},SingularAssociation.prototype.writer=function(resource,save){var localAssignment,_base,_this;return null==save&&(save=!0),null!=resource&&this.__raiseOnTypeMismatch(resource),_this=this,localAssignment=function(){return save&&_this.loaded(!0),_this.replace(resource)},save&&!("function"==typeof(_base=this.owner).newResource?_base.newResource():void 0)?this.__persistAssignment(resource).then(localAssignment):localAssignment()},SingularAssociation.prototype.build=function(attributes){var resource;return null==attributes&&(attributes={}),resource=this.__buildResource(attributes),this.replace(resource),resource},SingularAssociation.prototype.create=function(attributes,queryParams,callback){return null==attributes&&(attributes={}),null==queryParams&&(queryParams={}),this.__createResource(attributes,queryParams,callback)},SingularAssociation.prototype.replace=function(resource){return raise("Subclasses must implement a replace(resource) method")},SingularAssociation.prototype.__persistAssignment=function(resource){return this["interface"]().patch(this.links().self,resource,{onlyResourceIdentifiers:!0})},SingularAssociation.prototype.__getResource=function(){return this["interface"]().get(this.links().related,this.owner.queryParamsForReflection(this.reflection))},SingularAssociation.prototype.__findTarget=function(){var _this;return _this=this,this.__getResource().then(function(resource){return _this.setInverseInstance(resource)})},SingularAssociation.prototype.__createResource=function(attributes,queryParams,callback){var resource,_base,_this;if(!("function"==typeof(_base=this.owner).persisted?_base.persisted():void 0))throw"You cannot call create on an association unless the parent is saved";return resource=this.__buildResource(attributes),resource.assignQueryParams(queryParams),this.replace(resource),_this=this,resource.save(callback).then(function(){return _this.loaded(!0),resource})},SingularAssociation}(ActiveResource.prototype.Associations.prototype.Association)}.call(this),function(){var _ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};ActiveResource.prototype.Associations.prototype.HasOneAssociation=function(_super){function HasOneAssociation(){return _ref=HasOneAssociation.__super__.constructor.apply(this,arguments)}return __extends(HasOneAssociation,_super),HasOneAssociation.prototype.replace=function(resource){return this.__removeTarget(),resource?(this.__setOwnerAttributes(resource),this.setInverseInstance(resource),this.target=resource):void 0},HasOneAssociation.prototype.__removeTarget=function(){return this.target&&this.__nullifyOwnerAttributes(this.target),this.target=null;
},HasOneAssociation.prototype.__nullifyOwnerAttributes=function(resource){return resource[this.reflection.foreignKey()]=null},HasOneAssociation}(ActiveResource.prototype.Associations.prototype.SingularAssociation)}.call(this),function(){var _ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};ActiveResource.prototype.Associations.prototype.BelongsToAssociation=function(_super){function BelongsToAssociation(){return _ref=BelongsToAssociation.__super__.constructor.apply(this,arguments)}return __extends(BelongsToAssociation,_super),BelongsToAssociation.prototype.reset=function(){return BelongsToAssociation.__super__.reset.apply(this,arguments),this.updated=!1},BelongsToAssociation.prototype.replace=function(resource){return resource?(this.__replaceKeys(resource),this.setInverseInstance(resource),this.updated=!0):this.__removeKeys(),this.target=resource},BelongsToAssociation.prototype.__getResource=function(){return this.owner.newResource()?this["interface"]().get(this.links().related+this.owner[this.reflection.foreignKey()],this.owner.queryParamsForReflection(this.reflection)):BelongsToAssociation.__super__.__getResource.apply(this,arguments)},BelongsToAssociation.prototype.__replaceKeys=function(resource){return this.owner[this.reflection.foreignKey()]=resource.__readAttribute(this.reflection.associationPrimaryKey(resource.klass()))},BelongsToAssociation.prototype.__removeKeys=function(){return this.owner[this.reflection.foreignKey()]=null},BelongsToAssociation.prototype.__foreignKeyPresent=function(){return null!=this.owner.__readAttribute(this.reflection.foreignKey())},BelongsToAssociation.prototype.__invertibleFor=function(resource){var inverse;return inverse=this.__inverseReflectionFor(resource),inverse&&("function"==typeof inverse.hasOne?inverse.hasOne():void 0)},BelongsToAssociation}(ActiveResource.prototype.Associations.prototype.SingularAssociation)}.call(this),function(){var _ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};ActiveResource.prototype.Associations.prototype.BelongsToPolymorphicAssociation=function(_super){function BelongsToPolymorphicAssociation(){return _ref=BelongsToPolymorphicAssociation.__super__.constructor.apply(this,arguments)}return __extends(BelongsToPolymorphicAssociation,_super),BelongsToPolymorphicAssociation.prototype.klass=function(){var type;type=this.owner[this.reflection.foreignType()];try{return this.owner.klass().resourceLibrary.constantize(type)}catch(_error){return void 0}},BelongsToPolymorphicAssociation.prototype.links=function(){return this.klass()?BelongsToPolymorphicAssociation.__super__.links.apply(this,arguments):{}},BelongsToPolymorphicAssociation.prototype.__replaceKeys=function(resource){return BelongsToPolymorphicAssociation.__super__.__replaceKeys.apply(this,arguments),this.owner[this.reflection.foreignType()]=resource.klass().className},BelongsToPolymorphicAssociation.prototype.__removeKeys=function(){return BelongsToPolymorphicAssociation.__super__.__removeKeys.apply(this,arguments),this.owner[this.reflection.foreignType()]=null},BelongsToPolymorphicAssociation.prototype.__inverseReflectionFor=function(resource){return this.reflection.polymorphicInverseOf(resource.klass())},BelongsToPolymorphicAssociation.prototype.__raiseOnTypeMismatch=function(resource){},BelongsToPolymorphicAssociation}(ActiveResource.prototype.Associations.prototype.BelongsToAssociation)}.call(this),function(){ActiveResource.prototype.Associations.prototype.Builder=function(){function Builder(){}return Builder.__excludeFromExtend=!0,Builder.prototype.Association=function(){function Association(){}return Association.build=function(model,name,options){var reflection;return reflection=ActiveResource.prototype.Reflection.create(this.macro,name,options,model),this.defineAccessors(model,reflection),reflection},Association.defineAccessors=function(model,reflection){var name;return name=reflection.name,this.defineReaders(model,name),this.defineWriters(model,name)},Association.defineReaders=function(mixin,name){return mixin.prototype[name]=function(){return this.association(name).reader()},mixin.prototype["load"+s.capitalize(name)]=function(){return this.association(name).loadTarget()}},Association.defineWriters=function(mixin,name){return _.noop()},Association}(),Builder}.call(this)}.call(this),function(){var _ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};ActiveResource.prototype.Associations.prototype.Builder.prototype.CollectionAssociation=function(_super){function CollectionAssociation(){return _ref=CollectionAssociation.__super__.constructor.apply(this,arguments)}return __extends(CollectionAssociation,_super),CollectionAssociation}(ActiveResource.prototype.Associations.prototype.Builder.prototype.Association)}.call(this),function(){var _ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};ActiveResource.prototype.Associations.prototype.Builder.prototype.HasMany=function(_super){function HasMany(){return _ref=HasMany.__super__.constructor.apply(this,arguments)}return __extends(HasMany,_super),HasMany.macro="hasMany",HasMany}(ActiveResource.prototype.Associations.prototype.Builder.prototype.CollectionAssociation)}.call(this),function(){var _ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};ActiveResource.prototype.Associations.prototype.Builder.prototype.SingularAssociation=function(_super){function SingularAssociation(){return _ref=SingularAssociation.__super__.constructor.apply(this,arguments)}return __extends(SingularAssociation,_super),SingularAssociation.defineAccessors=function(model,reflection){return SingularAssociation.__super__.constructor.defineAccessors.apply(this,arguments),("function"==typeof reflection.constructable?reflection.constructable():void 0)?this.defineConstructors(model,reflection.name):void 0},SingularAssociation.defineWriters=function(mixin,name){return mixin.prototype["assign"+s.capitalize(name)]=function(value){return this.association(name).writer(value,!1)},mixin.prototype["update"+s.capitalize(name)]=function(value){return this.association(name).writer(value)}},SingularAssociation.defineConstructors=function(mixin,name){return mixin.prototype["build"+s.capitalize(name)]=function(attributes){return this.association(name).build(attributes)},mixin.prototype["create"+s.capitalize(name)]=function(attributes,callback){return this.association(name).create(attributes,callback)}},SingularAssociation}(ActiveResource.prototype.Associations.prototype.Builder.prototype.Association)}.call(this),function(){var _ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};ActiveResource.prototype.Associations.prototype.Builder.prototype.BelongsTo=function(_super){function BelongsTo(){return _ref=BelongsTo.__super__.constructor.apply(this,arguments)}return __extends(BelongsTo,_super),BelongsTo.macro="belongsTo",BelongsTo}(ActiveResource.prototype.Associations.prototype.Builder.prototype.SingularAssociation)}.call(this),function(){var _ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};ActiveResource.prototype.Associations.prototype.Builder.prototype.HasOne=function(_super){function HasOne(){return _ref=HasOne.__super__.constructor.apply(this,arguments)}return __extends(HasOne,_super),HasOne.macro="hasOne",HasOne}(ActiveResource.prototype.Associations.prototype.Builder.prototype.SingularAssociation)}.call(this),ActiveResource});